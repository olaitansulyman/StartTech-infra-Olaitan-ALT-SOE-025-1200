name: Backend CI/CD

on:
  repository_dispatch:
    types: [backend-deploy]
  workflow_dispatch:
    inputs:
      backend_repo:
        description: 'Backend repository URL'
        required: true
        default: 'https://github.com/username/starttech-backend'

env:
  AWS_REGION: 'us-east-1'
  GO_VERSION: '1.21'

jobs:
  build-and-deploy:
    name: Build and Deploy Backend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout infrastructure code
      uses: actions/checkout@v4

    - name: Checkout backend code
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.client_payload.repo || github.event.inputs.backend_repo }}
        token: ${{ secrets.GITHUB_TOKEN }}
        path: backend-app

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('backend-app/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      working-directory: backend-app
      run: go mod download

    - name: Run tests
      working-directory: backend-app
      run: go test -v ./...

    - name: Run security scan
      uses: securecodewarrior/github-action-gosec@master
      with:
        args: './backend-app/...'

    - name: Build application
      working-directory: backend-app
      run: |
        CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

    - name: Build Docker image
      working-directory: backend-app
      run: |
        docker build -t starttech-backend:${{ github.sha }} .
        docker tag starttech-backend:${{ github.sha }} starttech-backend:latest

    - name: Scan Docker image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'starttech-backend:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Create ECR repository if not exists
      run: |
        aws ecr describe-repositories --repository-names starttech-backend || \
        aws ecr create-repository --repository-name starttech-backend

    - name: Push to ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      run: |
        docker tag starttech-backend:latest $ECR_REGISTRY/starttech-backend:latest
        docker tag starttech-backend:latest $ECR_REGISTRY/starttech-backend:${{ github.sha }}
        docker push $ECR_REGISTRY/starttech-backend:latest
        docker push $ECR_REGISTRY/starttech-backend:${{ github.sha }}

    - name: Get Auto Scaling Group name
      id: get-asg
      run: |
        cd terraform
        terraform init
        ASG_NAME=$(terraform output -raw autoscaling_group_name || echo "starttech-backend-asg")
        echo "asg_name=$ASG_NAME" >> $GITHUB_OUTPUT

    - name: Trigger rolling deployment
      run: |
        # Start instance refresh for rolling deployment
        aws autoscaling start-instance-refresh \
          --auto-scaling-group-name ${{ steps.get-asg.outputs.asg_name }} \
          --preferences MinHealthyPercentage=50,InstanceWarmup=300

    - name: Wait for deployment
      run: |
        echo "Waiting for instance refresh to complete..."
        aws autoscaling wait instance-refresh-successful \
          --auto-scaling-group-name ${{ steps.get-asg.outputs.asg_name }}

    - name: Health check
      run: |
        cd terraform
        ALB_DNS=$(terraform output -raw alb_dns_name)
        echo "Performing health check on http://$ALB_DNS/health"
        
        for i in {1..10}; do
          if curl -f "http://$ALB_DNS/health"; then
            echo "Health check passed!"
            break
          fi
          echo "Health check attempt $i failed, retrying in 30s..."
          sleep 30
        done

    - name: Deployment Summary
      run: |
        echo "## Backend Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker Image**: ${{ steps.login-ecr.outputs.registry }}/starttech-backend:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Auto Scaling Group**: ${{ steps.get-asg.outputs.asg_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Deployed successfully" >> $GITHUB_STEP_SUMMARY